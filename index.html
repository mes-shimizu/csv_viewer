<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Viewer and Editor</title>
    <!-- Tailwind CSSをCDN経由で読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google FontsからInterフォントを読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 日本語フォントと英語フォントの指定 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* ファイル入力フィールドを非表示にする */
        #csvFileInput {
            display: none;
        }
        /* 編集可能なセルのスタイル */
        [contenteditable="true"] {
            outline: 2px solid transparent;
            transition: outline-color 0.2s;
        }
        [contenteditable="true"]:focus {
            outline-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- ヘッダーセクション -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">CSV Viewer and Editor</h1>
            <p class="mt-2 text-gray-600">CSVファイルを読み込み、編集して保存できます。</p>
        </header>

        <!-- 操作セクション -->
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <!-- ファイル選択ボタン -->
                <label for="csvFileInput" class="cursor-pointer bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-sm text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                    CSVファイルを選択
                </label>
                <!-- 文字コード選択 -->
                <div class="flex items-center gap-2">
                    <label for="encodingSelector" class="text-sm font-medium text-gray-700">文字コード:</label>
                    <select id="encodingSelector" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="UTF-8">UTF-8</option>
                        <option value="Shift_JIS" selected>Shift_JIS</option>
                    </select>
                </div>
                <!-- 保存ボタン -->
                <button id="saveButton" disabled class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V7a1 1 0 011-1h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
                    </svg>
                    CSVを保存
                </button>
            </div>
             <!-- 実際のファイル入力フィールド（非表示） -->
            <input type="file" id="csvFileInput" accept=".csv">
            <p id="fileName" class="mt-4 text-sm text-gray-500 text-center">ファイルが選択されていません</p>
        </div>

        <!-- テーブル表示セクション -->
        <div id="tableContainer" class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table id="csvTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <!-- ヘッダー行はJavaScriptで動的に生成されます -->
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                ファイルを選択すると、ここにデータが表示されます。
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // DOM要素を取得
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const tableHead = document.querySelector('#csvTable thead');
        const tableBody = document.querySelector('#csvTable tbody');
        const encodingSelector = document.getElementById('encodingSelector');
        const saveButton = document.getElementById('saveButton');
        let originalFileName = 'data.csv';

        // ファイル選択イベント
        csvFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                fileNameDisplay.textContent = 'ファイルが選択されていません';
                saveButton.disabled = true;
                return;
            }
            originalFileName = file.name;
            fileNameDisplay.textContent = `編集中: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                updateTable(text);
                saveButton.disabled = false; // テーブルが読み込まれたら保存ボタンを有効化
            };
            const encoding = encodingSelector.value;
            reader.readAsText(file, encoding);
        });

        // 保存ボタンのクリックイベント
        saveButton.addEventListener('click', () => {
            const csvContent = tableToCSV();
            downloadCSV(csvContent, `edited_${originalFileName}`);
        });

        /**
         * HTMLテーブルの内容をCSV形式の文字列に変換する関数
         * @returns {string} CSV形式の文字列
         */
        function tableToCSV() {
            const rows = [];
            // ヘッダー行を取得
            const headerCells = Array.from(tableHead.querySelectorAll('th')).map(th => `"${th.textContent.trim()}"`);
            rows.push(headerCells.join(','));

            // データ行を取得
            Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
                const cells = Array.from(tr.querySelectorAll('td')).map(td => `"${td.textContent.trim()}"`);
                rows.push(cells.join(','));
            });
            return rows.join('\n');
        }

        /**
         * CSVコンテンツをファイルとしてダウンロードさせる関数
         * @param {string} csvContent - ダウンロードするCSV文字列
         * @param {string} fileName - ダウンロード時のファイル名
         */
        function downloadCSV(csvContent, fileName) {
            // BOM（バイトオーダーマーク）を先頭に追加してExcelでの文字化けを防ぐ
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        /**
         * CSVテキストをパースしてHTMLテーブルを更新する関数
         * @param {string} csvText - 読み込まれたCSVファイルのテキストデータ
         */
        function updateTable(csvText) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            const rows = csvText.trim().split(/\r?\n/);
            if (rows.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">ファイルにデータがありません。</td></tr>`;
                return;
            }

            const headerRow = document.createElement('tr');
            const headers = rows[0].split(',');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText.trim();
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10';
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            const dataRows = rows.slice(1);
            dataRows.forEach(rowText => {
                if (rowText.trim() === '') return;
                const dataRow = document.createElement('tr');
                const cells = rowText.split(',');
                cells.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData.trim();
                    td.setAttribute('contenteditable', 'true'); // セルを編集可能にする
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800';
                    dataRow.appendChild(td);
                });
                dataRow.classList.add('hover:bg-gray-50', 'transition-colors', 'duration-150');
                tableBody.appendChild(dataRow);
            });

            if (dataRows.length === 0 || (dataRows.length === 1 && dataRows[0].trim() === '')) {
                 tableBody.innerHTML = `<tr><td colspan="${headers.length}" class="px-6 py-12 text-center text-gray-500">ヘッダー以外のデータがありません。</td></tr>`;
            }
        }
    </script>

</body>
</html>
